<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importar M3U - M3U Manager</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/responsive.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
</head>
<body>
    <!-- Barra de navegación -->
    <nav class="navbar navbar-expand-lg navbar-theme fixed-top">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="navbarOffcanvasLg" aria-label="Toggle navigation" data-bs-theme="dark"><span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand" href="dashboard.html">
                <i class="bi bi-collection-play me-2"></i>
                .m3uManager
            </a>
            <div class="collapse navbar-collapse justify-content-center" id="navbarNavAltMarkup">
              <div class="navbar-nav nav-underline">
                <a class="nav-link text-white me-2" href="dashboard.html">
                    <i class="bi bi-speedometer2 me-2"></i>Dashboard
                </a>
                <a class="nav-link text-white me-2" href="lists.html">
                    <i class="bi bi-list-ul me-2"></i>Mis Listas
                </a>
                <a class="nav-link text-white active me-2" href="scan.html">
                    <i class="bi bi-upload me-2"></i>Importar M3U
                </a>
                <a class="nav-link text-white me-2" href="settings.html">
                    <i class="bi bi-gear me-2"></i>Configuración
                </a>
              </div>
            </div>
            <!-- Menú usuario -->
            <div class="text-white ms-auto align-items-center">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" 
                       data-bs-toggle="dropdown">
                        <div class="me-2">
                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" 
                                 style="width: 32px; height: 32px;">
                                <i class="bi bi-person text-success-emphasis"></i>
                            </div>
                        </div>
                        <span id="userName" class="d-none d-md-block">Usuario</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="settings.html">
                            <i class="bi bi-gear me-2"></i>Configuración
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="logoutBtn">
                            <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="offcanvas offcanvas-start navbar-theme text-white" tabindex="-1" id="sidebar" 
         style="width: 280px;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Menú</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0">
            <nav class="nav flex-column">
                <a class="nav-link active text-white py-3 border-bottom border-secondary" href="dashboard.html">
                    <i class="bi bi-speedometer2 me-3"></i>Dashboard
                </a>
                <a class="nav-link text-white py-3 border-bottom border-secondary" href="lists.html">
                    <i class="bi bi-list-ul me-3"></i>Mis Listas
                </a>
                <a class="nav-link text-white py-3 border-bottom border-secondary" href="scan.html">
                    <i class="bi bi-upload me-3"></i>Importar M3U
                </a>
                <a class="nav-link text-white py-3 border-bottom border-secondary" href="settings.html">
                    <i class="bi bi-gear me-3"></i>Configuración
                </a>
            </nav>
            
            <!-- Información del plan -->
            <div class="p-3 border-top border-secondary mt-auto">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-light">Plan Actual</small>
                    <span class="badge bg-warning text-dark">Gratuito</span>
                </div>
                <div class="progress" style="height: 5px;">
                    <div class="progress-bar bg-success" style="width: 33%"></div>
                </div>
                <small class="text-white-50">1 de 3 listas utilizadas</small>
            </div>
        </div>
    </div>

    <!-- Contenido principal -->
    <main class="container py-4">
        <div class="row">
            <div class="col-12">
                <!-- Breadcrumb -->
                <nav aria-label="breadcrumb" class="mb-2">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></li>
                        <li class="breadcrumb-item active" aria-current="page">
                            <i class="bi bi-upload me-1"></i>Importar M3U
                        </li>
                    </ol>
                </nav>

                <!-- Encabezado -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="h3 text-theme text-start mb-0">Importar Archivo M3U</h1>
                        <p class="text-muted mb-0">Escanea y extrae canales desde archivos M3U</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-secondary d-none d-md-inline" onclick="window.history.back()">
                            <i class="bi bi-arrow-left me-1"></i>Volver
                        </button>
                    </div>
                </div>

                <!-- Pasos del proceso -->







                <div class="hori-timeline">
                    <ul class="list-inline events steps">
                        <li class="list-inline-item event-list step active">
                            <div class="px-4">
                                <div class="event-date text-white bg-theme step-number">1</div>
                                <p class="text-muted step-label">Subir Archivo</p>
                            </div>
                        </li>
                        <li class="list-inline-item event-list step">
                            <div class="px-4">
                                <div class="event-date text-white bg-theme step-number">2</div>
                                <p class="text-muted step-label">Revisar Canales</p>
                            </div>
                        </li>
                        <li class="list-inline-item event-list step">
                            <div class="px-4">
                                <div class="event-date text-white bg-theme step-number">3</div>
                                <p class="text-muted step-label">Importar</p>
                            </div>
                        </li>
                    </ul>
                </div>


                <!-- Paso 1: Subir archivo -->
                <div class="row" id="step1">
                    <div class="col-lg-12 mx-auto">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-cloud-upload me-2"></i>Subir Archivo M3U
                                </h5>
                            </div>
                            <div class="card-body text-center p-5">
                                <div class="mb-4">
                                    <i class="bi bi-file-earmark-text text-primary" style="font-size: 4rem;"></i>
                                </div>
                                <h4 class="mb-3">Arrastra y suelta tu archivo M3U</h4>
                                <p class="text-muted mb-4">
                                    Selecciona un archivo .m3u o .m3u8 para importar tus canales
                                </p>
                                
                                <div class="border-dashed p-4 rounded-3 mb-4" id="dropZone">
                                    <input type="file" 
                                           class="d-none" 
                                           id="m3uFile" 
                                           accept=".m3u,.m3u8,.txt">
                                    <label for="m3uFile" class="btn btn-outline-primary btn-lg mb-3">
                                        <i class="bi bi-folder2-open me-2"></i>Seleccionar Archivo
                                    </label>
                                    <p class="text-muted mb-0">o arrastra y suelta el archivo aquí</p>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <small>
                                        El archivo debe estar en formato M3U estándar. 
                                        Se extraerán automáticamente los nombres, logos, categorías y URLs de los canales.
                                    </small>
                                </div>
                                
                                <!-- Información del archivo seleccionado -->
                                <div class="d-none" id="fileInfo">
                                    <div class="card border-success">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-0" id="fileName"></h6>
                                                    <small class="text-muted" id="fileSize"></small>
                                                </div>
                                                <div>
                                                    <button class="btn btn-sm btn-outline-danger" id="removeFile">
                                                        <i class="bi bi-x-circle"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <div class="mb-3">
                                            <label for="targetList" class="form-label">Seleccionar Lista Destino</label>
                                            <select class="form-select" id="targetList" required>
                                                <option value="">Seleccionar lista</option>
                                                <!-- Se llena dinámicamente -->
                                            </select>
                                        </div>
                                        
                                        <div class="form-check text-start my-4">
                                            <input class="form-check-input" type="checkbox" id="verifyChannels">
                                            <label class="form-check-label" for="verifyChannels">
                                                Verificar estado de los canales durante la importación
                                            </label>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button class="btn btn-primary btn-lg" id="scanFile">
                                                <i class="bi bi-search me-2"></i>Escanear Archivo
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Paso 2: Revisar canales (oculto inicialmente) -->
                <div class="row d-none" id="step2">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-list-check me-2"></i>Canales Detectados
                                </h5>
                                <div>
                                    <span class="badge bg-light text-dark" id="channelsCount">0 canales</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Filtros de revisión -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="bi bi-search"></i>
                                            </span>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="filterScanned" 
                                                   placeholder="Buscar en canales escaneados...">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="filterScannedStatus">
                                            <option value="">Todos los estados</option>
                                            <option value="active">Solo activos</option>
                                            <option value="inactive">Solo inactivos</option>
                                            <option value="unknown">Sin verificar</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-primary w-100" id="selectAll">
                                            <i class="bi bi-check-square me-1"></i>Seleccionar Todos
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Tabla de canales escaneados -->
                                <div class="table-responsive">
                                    <table class="table table-hover" id="scannedChannelsTable">
                                        <thead>
                                            <tr>
                                                <th width="50">
                                                    <input type="checkbox" id="selectAllCheckbox">
                                                </th>
                                                <th width="80">Logo</th>
                                                <th>Nombre</th>
                                                <th>Categoría</th>
                                                <th>URL</th>
                                                <th width="100">Estado</th>
                                                <th width="100">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="scannedChannelsBody">
                                            <!-- Se llena dinámicamente -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Mensaje sin canales -->
                                <div id="noScannedChannels" class="text-center py-5">
                                    <i class="bi bi-search text-muted" style="font-size: 4rem;"></i>
                                    <h4 class="mt-3">No se encontraron canales</h4>
                                    <p class="text-muted">Sube un archivo M3U para comenzar el escaneo</p>
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span id="selectedCount">0</span> canales seleccionados
                                    </div>
                                    <div>
                                        <button class="btn btn-secondary me-2" id="backToStep1">
                                            <i class="bi bi-arrow-left me-1"></i>Volver
                                        </button>
                                        <button class="btn btn-primary" id="continueToImport">
                                            Continuar <i class="bi bi-arrow-right ms-1"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Paso 3: Importar (oculto inicialmente) -->
                <div class="row d-none" id="step3">
                    <div class="col-lg-8 mx-auto">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-download me-2"></i>Importar Canales
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Resumen de importación -->
                                <div class="mb-4">
                                    <h5>Resumen de Importación</h5>
                                    <div class="row mt-3">
                                        <div class="col-md-4">
                                            <div class="text-center p-3 border rounded">
                                                <h2 class="text-primary" id="totalToImport">0</h2>
                                                <small class="text-muted">Canales a Importar</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-center p-3 border rounded">
                                                <h2 class="text-success" id="activeToImport">0</h2>
                                                <small class="text-muted">Canales Activos</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-center p-3 border rounded">
                                                <h2 class="text-danger" id="inactiveToImport">0</h2>
                                                <small class="text-muted">Canales Inactivos</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Opciones de importación -->
                                <div class="mb-4">
                                    <h5>Opciones de Importación</h5>
                                    <div class="row mt-3">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Acción para duplicados</label>
                                            <select class="form-select" id="duplicateAction">
                                                <option value="skip">Saltar canales existentes</option>
                                                <option value="replace">Reemplazar canales existentes</option>
                                                <option value="rename">Renombrar (agregar sufijo)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Categoría predeterminada</label>
                                            <select class="form-select" id="defaultCategory">
                                                <option value="">Usar categorías del archivo</option>
                                                <!-- Se llena dinámicamente -->
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Progreso de importación -->
                                <div class="mb-4 d-none" id="importProgressContainer">
                                    <h5>Progreso de Importación</h5>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             id="importProgress" 
                                             style="width: 0%"></div>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <small id="importStatus">Preparando...</small>
                                        <small id="importPercent">0%</small>
                                    </div>
                                    
                                    <!-- Detalles de importación -->
                                    <div class="mt-3" id="importDetails">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <small class="text-muted">Importados:</small>
                                                <div id="importedCount">0</div>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted">Fallidos:</small>
                                                <div id="failedCount">0</div>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted">Saltados:</small>
                                                <div id="skippedCount">0</div>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted">Tiempo:</small>
                                                <div id="importTime">0s</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Resultado de importación -->
                                <div class="d-none" id="importResult">
                                    <div class="alert alert-success">
                                        <h5>
                                            <i class="bi bi-check-circle-fill me-2"></i>
                                            Importación Completada
                                        </h5>
                                        <p id="importResultMessage"></p>
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary" id="viewImportedChannels">
                                            <i class="bi bi-eye me-2"></i>Ver Canales Importados
                                        </button>
                                        <button class="btn btn-primary" id="importAnother">
                                            <i class="bi bi-upload me-2"></i>Importar Otro Archivo
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-secondary" id="backToStep2">
                                        <i class="bi bi-arrow-left me-1"></i>Volver
                                    </button>
                                    <button class="btn btn-primary" id="startImport">
                                        <i class="bi bi-download me-1"></i>Comenzar Importación
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información sobre formatos M3U -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-theme text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-info-circle me-2"></i>Información sobre Formatos M3U
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <h6>Formato Básico M3U</h6>
                                        <pre class="bg-light p-2 rounded"><code>#EXTM3U
#EXTINF:-1,Channel Name
http://example.com/stream.m3u8</code></pre>
                                    </div>
                                    <div class="col-md-4">
                                        <h6>Formato Extendido M3U</h6>
                                        <pre class="bg-light p-2 rounded"><code>#EXTM3U
#EXTINF:-1 tvg-id="ID" tvg-name="Name" tvg-logo="logo.png" group-title="Category",Channel Name
http://example.com/stream.m3u8</code></pre>
                                    </div>
                                    <div class="col-md-4">
                                        <h6>Consejos</h6>
                                        <ul class="small">
                                            <li>El archivo debe comenzar con #EXTM3U</li>
                                            <li>Cada canal requiere una línea #EXTINF y una línea de URL</li>
                                            <li>Los metadatos se extraen automáticamente</li>
                                            <li>El tamaño máximo permitido es 10MB</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="navbar-theme text-white py-3 mt-4">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-6 text-center">
                    <small>&copy; 2024 M3U Manager. Todos los derechos reservados.</small>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <small>
                        <a href="disclaimer.html" class="text-white text-decoration-none me-3">Descargo</a>
                        <a href="privacy-policy.html" class="text-white text-decoration-none">Privacidad</a>
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Auth JS -->
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <!-- M3U Parser -->
    <script src="https://cdn.jsdelivr.net/npm/m3u8-parser@6.0.0/dist/m3u8-parser.min.js"></script>
    <!-- Scan JS -->
    <script src="js/scan.js"></script>
</body>
</html>